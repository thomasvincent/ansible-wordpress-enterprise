# Ubuntu 22.04 test target for WordPress Enterprise testing
FROM ubuntu:22.04

# Avoid interactive prompts during package installation
ENV DEBIAN_FRONTEND=noninteractive
ENV TZ=UTC

# Install systemd and basic packages
RUN apt-get update && apt-get install -y \
    systemd \
    systemd-sysv \
    init \
    openssh-server \
    python3 \
    python3-pip \
    curl \
    wget \
    gnupg \
    lsb-release \
    apt-transport-https \
    ca-certificates \
    software-properties-common \
    sudo \
    rsyslog \
    cron \
    logrotate \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# Configure systemd
RUN systemctl set-default multi-user.target \
    && systemctl enable ssh \
    && systemctl enable rsyslog \
    && systemctl enable cron

# Remove unnecessary systemd services
RUN systemctl disable getty@tty1.service \
    && systemctl mask getty@tty1.service \
    && systemctl mask getty-static.service \
    && systemctl mask graphical-session.target \
    && systemctl mask systemd-logind.service \
    && systemctl mask systemd-user-sessions.service

# Create test user with sudo privileges
RUN useradd -m -s /bin/bash -G sudo testuser \
    && echo 'testuser:testpass123' | chpasswd \
    && echo 'testuser ALL=(ALL) NOPASSWD:ALL' >> /etc/sudoers

# Configure SSH
RUN mkdir -p /var/run/sshd \
    && echo 'root:testroot123' | chpasswd \
    && sed -i 's/#PermitRootLogin prohibit-password/PermitRootLogin yes/' /etc/ssh/sshd_config \
    && sed -i 's/#PasswordAuthentication yes/PasswordAuthentication yes/' /etc/ssh/sshd_config

# Create directory for WordPress installation
RUN mkdir -p /var/www/html \
    && chown -R www-data:www-data /var/www/html

# Create systemd-compatible init script
COPY tests/fixtures/init-ubuntu.sh /usr/local/bin/init-ubuntu.sh
RUN chmod +x /usr/local/bin/init-ubuntu.sh

# Expose SSH and web ports
EXPOSE 22 80 443

# Use systemd as init system
CMD ["/usr/local/bin/init-ubuntu.sh"]