---
# Apache WordPress Installation Test Scenario
# Tests: Prerequisites, PHP, Apache, WordPress core installation

- name: "Test 02 - WordPress Installation with Apache"
  hosts: wordpress_servers
  become: true
  gather_facts: true

  vars:
    # Basic WordPress configuration
    wordpress_version: "6.4.2"  # Specific version for testing
    wordpress_install_dir: "/var/www/apache-wordpress"
    wordpress_site_title: "Apache WordPress Test Site"
    wordpress_site_url: "http://{{ ansible_default_ipv4.address }}:8081"

    # Admin user
    wordpress_admin_user: "apacheadmin"
    wordpress_admin_password: "ApacheAdmin123!"
    wordpress_admin_email: "apache@test.local"

    # Database configuration (external MariaDB for CentOS test)
    wordpress_db_host: "wp-test-mariadb"
    wordpress_db_port: 3306
    wordpress_db_name: "wordpress_test_apache"
    wordpress_db_user: "wp_test_apache"
    wordpress_db_password: "wp_test_apache_pass"
    wordpress_db_charset: "utf8mb4"
    wordpress_db_collate: "utf8mb4_unicode_ci"
    wordpress_db_engine: "mariadb"

    # Web server configuration
    wordpress_web_server: "apache"
    wordpress_http_port: 80
    wordpress_https_port: 443

    # PHP configuration
    wordpress_php_version: "8.2"
    wordpress_php_memory_limit: "512M"
    wordpress_php_max_execution_time: "600"
    wordpress_php_upload_max_filesize: "128M"
    wordpress_php_post_max_size: "128M"
    wordpress_php_max_input_vars: "5000"

    # Advanced PHP settings
    wordpress_opcache_enable: true
    wordpress_opcache_memory: "256"
    wordpress_opcache_max_files: "10000"
    wordpress_opcache_validate_timestamps: "0"

    # System user
    wordpress_system_user: "www-data"
    wordpress_system_group: "www-data"
    wordpress_file_permissions: "0644"
    wordpress_dir_permissions: "0755"

    # Security testing
    wordpress_enable_ssl: false
    wordpress_generate_self_signed_cert: false

    # Caching - Memcached for variety
    wordpress_enable_memcached: true
    wordpress_memcached_servers:
      - "wp-test-memcached:11211"

    # Features
    wordpress_install_wpcli: true
    wordpress_enable_logging: true
    wordpress_debug: true  # Enable debug for testing

    # More comprehensive plugin testing
    wordpress_plugins:
      - name: "wordpress-seo"  # Yoast SEO
        version: "latest"
        state: "present"
        activate: true
      - name: "wp-super-cache"
        version: "latest"
        state: "present"
        activate: true
      - name: "contact-form-7"
        version: "latest"
        state: "present"
        activate: false
      - name: "updraftplus"
        version: "latest"
        state: "present"
        activate: false

    # Theme testing
    wordpress_themes:
      - name: "astra"
        version: "latest"
        state: "present"
        activate: true
      - name: "generatepress"
        version: "latest"
        state: "present"
        activate: false
      - name: "twentytwentythree"
        version: "latest"
        state: "present"
        activate: false

    # WordPress constants for testing
    wordpress_additional_constants:
      WP_DEBUG_LOG: true
      WP_DEBUG_DISPLAY: false
      SCRIPT_DEBUG: true
      CONCATENATE_SCRIPTS: false

  roles:
    - role: ../../
      become: true

  post_tasks:
    - name: Wait for Apache to be ready
      ansible.builtin.wait_for:
        port: "{{ wordpress_http_port }}"
        host: "{{ ansible_default_ipv4.address }}"
        delay: 15
        timeout: 300
      delegate_to: localhost

    - name: Test WordPress with Apache
      ansible.builtin.uri:
        url: "http://{{ ansible_default_ipv4.address }}"
        method: GET
        status_code: [200, 301, 302]
        timeout: 30
      delegate_to: localhost
      register: apache_wp_response

    - name: Test PHP info page (if debug enabled)
      ansible.builtin.uri:
        url: "http://{{ ansible_default_ipv4.address }}/phpinfo.php"
        method: GET
        status_code: [200, 404]  # 404 is OK if not created
      delegate_to: localhost
      register: phpinfo_response
      ignore_errors: true

    - name: Test plugin functionality (check for Yoast SEO)
      ansible.builtin.uri:
        url: "http://{{ ansible_default_ipv4.address }}/wp-admin/admin.php?page=wpseo_dashboard"
        method: GET
        status_code: [200, 301, 302, 404]  # Various redirect responses are OK
      delegate_to: localhost
      register: plugin_test
      ignore_errors: true

    - name: Display comprehensive test results
      ansible.builtin.debug:
        msg:
          - "✅ Apache WordPress installation test completed"
          - "✅ Site accessible at: http://{{ ansible_default_ipv4.address }}"
          - "✅ Response status: {{ apache_wp_response.status }}"
          - "✅ Web server: {{ wordpress_web_server }}"
          - "✅ PHP version: {{ wordpress_php_version }}"
          - "✅ Database: {{ wordpress_db_host }}:{{ wordpress_db_port }} ({{ wordpress_db_engine }})"
          - "✅ Cache: Memcached at {{ wordpress_memcached_servers }}"
          - "✅ OPcache enabled: {{ wordpress_opcache_enable }}"
          - "✅ Debug mode: {{ wordpress_debug }}"
          - "✅ Plugins installed: {{ wordpress_plugins | length }} plugins"
          - "✅ Themes installed: {{ wordpress_themes | length }} themes"
