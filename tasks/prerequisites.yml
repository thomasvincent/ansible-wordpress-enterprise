---
# Prerequisites installation and configuration

- name: Create WordPress system user
  ansible.builtin.user:
    name: "{{ wordpress_system_user }}"
    group: "{{ wordpress_system_group }}"
    system: true
    create_home: false
    shell: /bin/bash
    comment: "WordPress system user"
    state: present

- name: Create WordPress system group
  ansible.builtin.group:
    name: "{{ wordpress_system_group }}"
    system: true
    state: present

- name: Install system packages
  ansible.builtin.package:
    name: "{{ wordpress_system_packages }}"
    state: present
    update_cache: "{{ wordpress_update_cache }}"
  retries: 3
  delay: 5

- name: Create WordPress directories
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: "{{ wordpress_system_user }}"
    group: "{{ wordpress_system_group }}"
    mode: "0755"
  loop:
    - "{{ wordpress_install_dir }}"
    - "{{ wordpress_log_dir }}"
    - "{{ wordpress_backup_dir }}"
    - "/var/cache/wordpress"

- name: Set up SELinux contexts (RedHat)
  when:
    - ansible_os_family == "RedHat"
    - wordpress_selinux_enabled | bool
  block:
    - name: Install SELinux Python bindings
      ansible.builtin.package:
        name:
          - python3-libselinux
          - python3-policycoreutils
        state: present

    - name: Set SELinux booleans for WordPress
      ansible.posix.seboolean:
        name: "{{ item }}"
        state: true
        persistent: true
      loop: "{{ wordpress_selinux_booleans }}"

    - name: Set SELinux context for WordPress directory
      community.general.sefcontext:
        target: "{{ wordpress_install_dir }}(/.*)?"
        setype: httpd_sys_rw_content_t
        state: present

    - name: Apply SELinux context
      ansible.builtin.command:
        cmd: "restorecon -Rv {{ wordpress_install_dir }}"
      changed_when: false

