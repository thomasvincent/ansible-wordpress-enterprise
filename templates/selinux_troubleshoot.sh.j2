#!/bin/bash
# WordPress SELinux Troubleshooting Script
# Generated by Ansible on {{ ansible_date_time.iso8601 }}

echo "=== WordPress SELinux Troubleshooting ==="
echo "Generated at: $(date)"
echo "Hostname: {{ ansible_hostname }}"
echo "WordPress Path: {{ wordpress_install_dir }}"
echo ""

# Check SELinux status
echo "=== SELinux Status ==="
if command -v getenforce >/dev/null 2>&1; then
    echo "Current mode: $(getenforce)"
    echo "Config file mode: $(grep ^SELINUX= /etc/selinux/config | cut -d= -f2)"
    sestatus
else
    echo "SELinux is not available on this system"
    exit 1
fi
echo ""

# Check for recent denials
echo "=== Recent SELinux Denials ==="
echo "Checking audit log for WordPress-related denials..."
if ausearch -m avc -ts recent 2>/dev/null | grep -i wordpress; then
    echo ""
    echo "Found WordPress-related denials above."
else
    echo "No recent WordPress-related denials found."
fi

echo ""
echo "All recent SELinux denials (last 10):"
ausearch -m avc -ts recent 2>/dev/null | tail -20 || echo "No recent SELinux denials found"
echo ""

# Check file contexts
echo "=== WordPress File Contexts ==="
echo "WordPress directory contexts:"
ls -laZ {{ wordpress_install_dir }} | head -10
echo ""

echo "Key file contexts:"
if [ -f "{{ wordpress_install_dir }}/wp-config.php" ]; then
    ls -lZ {{ wordpress_install_dir }}/wp-config.php
else
    echo "wp-config.php not found"
fi

if [ -d "{{ wordpress_install_dir }}/wp-content" ]; then
    echo ""
    echo "wp-content directory contexts:"
    ls -laZ {{ wordpress_install_dir }}/wp-content | head -5
fi
echo ""

# Check SELinux booleans
echo "=== SELinux Booleans Status ==="
echo "WordPress/HTTP related booleans:"
getsebool -a | grep -E "(httpd|wordpress)" | sort
echo ""

# Check if contexts need restoring
echo "=== Context Restoration Check ==="
echo "Checking if file contexts need to be restored..."
restorecon -R -v -n {{ wordpress_install_dir }} 2>/dev/null | head -10 || echo "No context changes needed"
echo ""

# Generate common solutions
echo "=== Common WordPress SELinux Issues and Solutions ==="
echo ""
echo "1. Web server can't access WordPress files:"
echo "   Solution: setsebool -P httpd_can_network_connect on"
echo "   Solution: setsebool -P httpd_builtin_scripting on"
echo "   Solution: restorecon -R {{ wordpress_install_dir }}"
echo ""

echo "2. WordPress can't connect to database:"
echo "   Solution: setsebool -P httpd_can_network_connect_db on"
echo "   Solution: Check database server contexts if local"
echo ""

echo "3. File upload issues:"
echo "   Check: ls -laZ {{ wordpress_install_dir }}/wp-content/uploads/"
echo "   Solution: chcon -R -t httpd_sys_rw_content_t {{ wordpress_install_dir }}/wp-content/uploads/"
echo "   Solution: semanage fcontext -a -t httpd_sys_rw_content_t '{{ wordpress_install_dir }}/wp-content/uploads(/.*)?'"
echo ""

echo "4. Plugin/theme installation issues:"
echo "   Solution: setsebool -P httpd_can_network_connect on"
echo "   Solution: chcon -R -t httpd_sys_rw_content_t {{ wordpress_install_dir }}/wp-content/"
echo ""

echo "5. WordPress can't send emails:"
echo "   Solution: setsebool -P httpd_can_sendmail on"
echo ""

echo "6. Caching issues (Redis/Memcached):"
echo "   Solution: setsebool -P httpd_can_network_redis on"
echo "   Solution: setsebool -P httpd_can_network_memcache on"
echo ""

# Check for sealert if available
if command -v sealert >/dev/null 2>&1; then
    echo "=== SELinux Alert Analysis ==="
    echo "Recent SELinux alerts:"
    sealert -l "*" 2>/dev/null | grep -A 10 -B 5 -i wordpress || echo "No WordPress-related alerts found"
    echo ""
fi

# Provide manual commands
echo "=== Manual Troubleshooting Commands ==="
echo ""
echo "Check all recent denials:"
echo "  ausearch -m avc -ts recent"
echo ""
echo "Check specific service denials:"
echo "  ausearch -m avc -ts recent | grep httpd"
echo ""
echo "Generate policy from denials:"
echo "  ausearch -m avc -ts recent | audit2allow -M wordpress_custom"
echo "  semodule -i wordpress_custom.pp"
echo ""
echo "Set WordPress directory to permissive (temporary):"
echo "  semanage permissive -a httpd_t"
echo ""
echo "Check file contexts:"
echo "  matchpathcon {{ wordpress_install_dir }}/wp-config.php"
echo "  semanage fcontext -l | grep {{ wordpress_install_dir }}"
echo ""
echo "Restore default contexts:"
echo "  restorecon -R {{ wordpress_install_dir }}"
echo ""
echo "Enable common web server permissions:"
echo "  setsebool -P httpd_can_network_connect on"
echo "  setsebool -P httpd_can_network_connect_db on"
echo "  setsebool -P httpd_builtin_scripting on"
echo "  setsebool -P httpd_can_sendmail on"
echo ""

# Test basic connectivity
echo "=== WordPress Connectivity Test ==="
echo "Testing basic file access..."
if [ -r "{{ wordpress_install_dir }}/index.php" ]; then
    echo "✅ WordPress index.php is readable"
else
    echo "❌ Cannot read WordPress index.php - check file permissions and SELinux contexts"
fi

if [ -r "{{ wordpress_install_dir }}/wp-config.php" ]; then
    echo "✅ wp-config.php is readable"
else
    echo "❌ Cannot read wp-config.php - check file permissions and SELinux contexts"
fi

if [ -w "{{ wordpress_install_dir }}/wp-content/uploads" ]; then
    echo "✅ Uploads directory is writable"
else
    echo "❌ Uploads directory is not writable - check permissions and SELinux contexts"
fi
echo ""

# Generate quick fix script
echo "=== Quick Fix Script ==="
echo "Run this script to apply common WordPress SELinux fixes:"
echo ""
echo "#!/bin/bash"
echo "# WordPress SELinux Quick Fix"
echo "echo 'Applying WordPress SELinux fixes...'"
echo ""
echo "# Set SELinux booleans"
echo "setsebool -P httpd_can_network_connect on"
echo "setsebool -P httpd_can_network_connect_db on"
echo "setsebool -P httpd_builtin_scripting on"
echo "setsebool -P httpd_can_sendmail on"
echo ""
echo "# Set file contexts"
echo "semanage fcontext -a -t httpd_sys_content_t '{{ wordpress_install_dir }}(/.*)?'"
echo "semanage fcontext -a -t httpd_sys_rw_content_t '{{ wordpress_install_dir }}/wp-content(/.*)?'"
echo "semanage fcontext -a -t httpd_sys_rw_content_t '{{ wordpress_install_dir }}/wp-content/uploads(/.*)?'"
echo "semanage fcontext -a -t httpd_sys_rw_content_t '{{ wordpress_install_dir }}/wp-content/cache(/.*)?'"
echo ""
echo "# Apply contexts"
echo "restorecon -R {{ wordpress_install_dir }}"
echo ""
echo "echo 'WordPress SELinux fixes applied!'"
echo ""

echo "Save the above as a script and run with root privileges."
echo ""
echo "=== Need More Help? ==="
echo "1. Check the WordPress SELinux status: wordpress-selinux-status"
echo "2. Review audit logs: tail -f /var/log/audit/audit.log | grep AVC"
echo "3. Use sealert for detailed analysis: sealert -a /var/log/audit/audit.log"
echo "4. Consult Red Hat/CentOS SELinux documentation"
echo ""
echo "Troubleshooting completed at: $(date)"