---
# PHP installation and configuration tasks

- name: Install PHP and PHP-FPM
  ansible.builtin.package:
    name: "{{ wordpress_php_packages }}"
    state: present
  notify: restart php-fpm

- name: Configure PHP-FPM pool
  ansible.builtin.template:
    src: php-fpm-pool.conf.j2
    dest: "{{ wordpress_php_fpm_pool_dir }}/www.conf"
    owner: root
    group: root
    mode: '0644'
  notify: restart php-fpm

- name: Configure PHP.ini settings
  ansible.builtin.lineinfile:
    path: "{{ wordpress_php_ini_path }}"
    regexp: "^{{ item.key }} ="
    line: "{{ item.key }} = {{ item.value }}"
  loop:
    - { key: 'memory_limit', value: "{{ wordpress_php_memory_limit }}" }
    - { key: 'max_execution_time', value: "{{ wordpress_php_max_execution_time }}" }
    - { key: 'upload_max_filesize', value: "{{ wordpress_php_upload_max_filesize }}" }
    - { key: 'post_max_size', value: "{{ wordpress_php_post_max_size }}" }
    - { key: 'max_input_vars', value: "{{ wordpress_php_max_input_vars }}" }
  notify: restart php-fpm

- name: Configure OPcache settings
  ansible.builtin.lineinfile:
    path: "{{ wordpress_php_ini_path }}"
    regexp: "^{{ item.key }} ="
    line: "{{ item.key }} = {{ item.value }}"
  loop:
    - { key: 'opcache.enable', value: "{{ wordpress_opcache_enable | int }}" }
    - { key: 'opcache.memory_consumption', value: "{{ wordpress_opcache_memory }}" }
    - { key: 'opcache.max_accelerated_files', value: "{{ wordpress_opcache_max_files }}" }
    - { key: 'opcache.validate_timestamps', value: "{{ wordpress_opcache_validate_timestamps }}" }
  when: wordpress_opcache_enable | bool
  notify: restart php-fpm

- name: Enable PHP-FPM service
  ansible.builtin.systemd:
    name: "{{ wordpress_php_fpm_service }}"
    enabled: true
    state: started

