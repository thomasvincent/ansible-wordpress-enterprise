#!/bin/bash
# WordPress Enterprise Security Status Report
# Generated by Ansible on {{ ansible_date_time.iso8601 }}

echo "=== WordPress Enterprise Security Status Report ==="
echo "Generated at: $(date)"
echo "Hostname: {{ ansible_hostname }}"
echo "Distribution: {{ ansible_distribution }} {{ ansible_distribution_version }}"
echo "WordPress Path: {{ wordpress_path }}"
echo ""

# System Security Status
echo "=== System Security Overview ==="
{% if ansible_os_family == "RedHat" %}
if command -v getenforce >/dev/null 2>&1; then
    echo "SELinux Status: $(getenforce)"
    echo "SELinux Policy: $(sestatus | grep 'Policy from config file' | cut -d: -f2 | xargs 2>/dev/null || echo 'Unknown')"
else
    echo "SELinux: Not available"
fi
{% elif ansible_os_family == "Debian" %}
if command -v aa-status >/dev/null 2>&1; then
    echo "AppArmor Status: $(aa-status --enabled && echo 'Enabled' || echo 'Disabled')"
    echo "AppArmor Profiles: $(aa-status | grep profiles | head -1 | cut -d' ' -f1) loaded"
else
    echo "AppArmor: Not available"
fi
{% endif %}

echo "Kernel Version: {{ ansible_kernel }}"
echo "Architecture: {{ ansible_architecture }}"
echo ""

# WordPress File Permissions
echo "=== WordPress File Permissions ==="
if [ -d "{{ wordpress_path }}" ]; then
    echo "WordPress directory permissions:"
    ls -ld {{ wordpress_path }}
    
    echo ""
    echo "Key file permissions:"
    if [ -f "{{ wordpress_path }}/wp-config.php" ]; then
        ls -l {{ wordpress_path }}/wp-config.php
    else
        echo "wp-config.php: Not found"
    fi
    
    if [ -d "{{ wordpress_path }}/wp-content/uploads" ]; then
        ls -ld {{ wordpress_path }}/wp-content/uploads
    else
        echo "uploads directory: Not found"
    fi
    
    echo ""
    echo "Checking for world-writable files in WordPress:"
    find {{ wordpress_path }} -type f -perm -002 | head -10
else
    echo "WordPress directory not found: {{ wordpress_path }}"
fi
echo ""

# Service Status
echo "=== Security Services Status ==="
services=("fail2ban" "auditd" {% if ansible_os_family == "RedHat" %}"firewalld"{% else %}"ufw"{% endif %})

for service in "${services[@]}"; do
    if systemctl is-active --quiet "$service"; then
        status="Active"
    else
        status="Inactive"
    fi
    
    if systemctl is-enabled --quiet "$service" 2>/dev/null; then
        enabled="Enabled"
    else
        enabled="Disabled"
    fi
    
    echo "$service: $status ($enabled)"
done
echo ""

# Network Security
echo "=== Network Security ==="
echo "Open ports:"
if command -v ss >/dev/null 2>&1; then
    ss -tlnp | grep -E ':(80|443|22|3306|6379|11211)' | awk '{print $4}' | sort | uniq
else
    netstat -tlnp 2>/dev/null | grep -E ':(80|443|22|3306|6379|11211)' | awk '{print $4}' | sort | uniq
fi

echo ""
echo "Firewall status:"
{% if ansible_os_family == "RedHat" %}
if command -v firewall-cmd >/dev/null 2>&1; then
    firewall-cmd --state 2>/dev/null || echo "Firewalld not active"
    echo "Active zones:"
    firewall-cmd --get-active-zones 2>/dev/null || echo "No active zones"
else
    echo "Firewalld not available"
fi
{% else %}
if command -v ufw >/dev/null 2>&1; then
    ufw status
else
    echo "UFW not available"
fi
{% endif %}
echo ""

# Security Tools Status
echo "=== Security Tools Status ==="
security_tools=("fail2ban" "rkhunter" "chkrootkit" "logwatch")

for tool in "${security_tools[@]}"; do
    if command -v "$tool" >/dev/null 2>&1; then
        echo "$tool: Installed"
    else
        echo "$tool: Not installed"
    fi
done
echo ""

# Recent Security Events
echo "=== Recent Security Events ==="
echo "Recent fail2ban bans (last 10):"
if [ -f /var/log/fail2ban.log ]; then
    grep "Ban " /var/log/fail2ban.log | tail -10
else
    echo "No fail2ban log found"
fi

echo ""
echo "Recent authentication failures:"
if [ -f /var/log/auth.log ]; then
    grep "authentication failure" /var/log/auth.log | tail -5
elif [ -f /var/log/secure ]; then
    grep "authentication failure" /var/log/secure | tail -5
else
    echo "No authentication log found"
fi
echo ""

{% if ansible_os_family == "RedHat" %}
# SELinux Specific Information
echo "=== SELinux Security Details ==="
if command -v getenforce >/dev/null 2>&1 && [ "$(getenforce)" != "Disabled" ]; then
    echo "SELinux Booleans (WordPress related):"
    getsebool -a 2>/dev/null | grep -E "(httpd|wordpress)" | head -10
    
    echo ""
    echo "Recent SELinux denials (last 5):"
    ausearch -m avc -ts recent 2>/dev/null | grep -i wordpress | tail -5 || echo "No recent denials found"
    
    echo ""
    echo "WordPress file contexts:"
    ls -laZ {{ wordpress_path }} 2>/dev/null | head -5 || echo "Cannot read WordPress directory contexts"
else
    echo "SELinux is disabled or not available"
fi
echo ""
{% endif %}

{% if ansible_os_family == "Debian" %}
# AppArmor Specific Information
echo "=== AppArmor Security Details ==="
if command -v aa-status >/dev/null 2>&1; then
    echo "WordPress AppArmor profiles:"
    aa-status 2>/dev/null | grep -i wordpress || echo "No WordPress profiles found"
    
    echo ""
    echo "Recent AppArmor denials (last 5):"
    dmesg | grep -i "apparmor.*denied" | grep -i wordpress | tail -5 || echo "No recent denials found"
    
    echo ""
    echo "AppArmor profile modes:"
    for profile in wordpress-php-fpm wordpress-nginx wordpress-apache wordpress-wpcli; do
        if [ -f "/etc/apparmor.d/$profile" ]; then
            mode=$(aa-status 2>/dev/null | grep "$profile" | awk '{print $2}' || echo "not loaded")
            echo "$profile: $mode"
        fi
    done
else
    echo "AppArmor is not available"
fi
echo ""
{% endif %}

# WordPress Specific Security
echo "=== WordPress Security Analysis ==="
if [ -d "{{ wordpress_path }}" ]; then
    echo "Checking for common security issues:"
    
    # Check for debug mode
    if [ -f "{{ wordpress_path }}/wp-config.php" ]; then
        if grep -q "WP_DEBUG.*true" {{ wordpress_path }}/wp-config.php 2>/dev/null; then
            echo "âš ï¸  WARNING: Debug mode is enabled"
        else
            echo "âœ… Debug mode is disabled"
        fi
        
        # Check for security keys
        if grep -q "AUTH_KEY\|SECURE_AUTH_KEY\|LOGGED_IN_KEY" {{ wordpress_path }}/wp-config.php 2>/dev/null; then
            echo "âœ… Security keys are configured"
        else
            echo "âš ï¸  WARNING: Security keys may not be configured"
        fi
    fi
    
    # Check for suspicious files
    echo ""
    echo "Scanning for potentially malicious files:"
    suspicious_files=$(find {{ wordpress_path }} -name "*.php" -exec grep -l "eval\|base64_decode\|gzinflate" {} \; 2>/dev/null | wc -l)
    if [ "$suspicious_files" -gt 0 ]; then
        echo "âš ï¸  WARNING: Found $suspicious_files potentially suspicious PHP files"
        find {{ wordpress_path }} -name "*.php" -exec grep -l "eval\|base64_decode\|gzinflate" {} \; 2>/dev/null | head -5
    else
        echo "âœ… No obviously suspicious files found"
    fi
    
    # Check for .htaccess protection
    if [ "{{ wordpress_web_server }}" = "apache" ]; then
        if [ -f "{{ wordpress_path }}/wp-content/uploads/.htaccess" ]; then
            echo "âœ… Uploads directory protected with .htaccess"
        else
            echo "âš ï¸  WARNING: Uploads directory not protected"
        fi
    fi
else
    echo "WordPress directory not accessible"
fi
echo ""

# System Updates
echo "=== System Updates Status ==="
{% if ansible_os_family == "Debian" %}
if command -v apt-get >/dev/null 2>&1; then
    echo "Available security updates:"
    apt list --upgradable 2>/dev/null | grep -i security | wc -l
    echo ""
    echo "Last update check:"
    stat /var/lib/apt/lists 2>/dev/null | grep Modify | head -1 || echo "Unknown"
fi
{% else %}
if command -v yum >/dev/null 2>&1; then
    echo "Available security updates:"
    yum --security check-update 2>/dev/null | grep -c "security" || echo "0"
elif command -v dnf >/dev/null 2>&1; then
    echo "Available security updates:"
    dnf --security check-update 2>/dev/null | grep -c "security" || echo "0"
fi
{% endif %}
echo ""

# Summary
echo "=== Security Summary ==="
echo "âœ… = Secure  âš ï¸  = Needs attention  âŒ = Critical issue"
echo ""

# Generate overall security score
security_score=0
max_score=10

# Check each security aspect
if systemctl is-active --quiet fail2ban; then
    security_score=$((security_score + 2))
    echo "âœ… Fail2ban is active"
else
    echo "âš ï¸  Fail2ban is not active"
fi

{% if ansible_os_family == "RedHat" %}
if command -v getenforce >/dev/null 2>&1 && [ "$(getenforce)" = "Enforcing" ]; then
    security_score=$((security_score + 2))
    echo "âœ… SELinux is enforcing"
elif command -v getenforce >/dev/null 2>&1 && [ "$(getenforce)" = "Permissive" ]; then
    security_score=$((security_score + 1))
    echo "âš ï¸  SELinux is in permissive mode"
else
    echo "âŒ SELinux is disabled or not available"
fi
{% endif %}

{% if ansible_os_family == "Debian" %}
if command -v aa-status >/dev/null 2>&1 && aa-status --enabled; then
    security_score=$((security_score + 2))
    echo "âœ… AppArmor is active"
else
    echo "âš ï¸  AppArmor is not active"
fi
{% endif %}

if [ -f "{{ wordpress_path }}/wp-config.php" ] && [ "$(stat -c '%a' {{ wordpress_path }}/wp-config.php 2>/dev/null)" = "644" ]; then
    security_score=$((security_score + 1))
    echo "âœ… WordPress config has secure permissions"
else
    echo "âš ï¸  WordPress config permissions may be insecure"
fi

{% if ansible_os_family == "RedHat" %}
if systemctl is-active --quiet firewalld; then
    security_score=$((security_score + 1))
    echo "âœ… Firewall is active"
else
    echo "âš ï¸  Firewall is not active"
fi
{% else %}
if ufw status | grep -q "Status: active"; then
    security_score=$((security_score + 1))
    echo "âœ… Firewall is active"
else
    echo "âš ï¸  Firewall is not active"
fi
{% endif %}

if systemctl is-active --quiet auditd; then
    security_score=$((security_score + 1))
    echo "âœ… Audit daemon is active"
else
    echo "âš ï¸  Audit daemon is not active"
fi

# Check for automatic updates
{% if ansible_os_family == "Debian" %}
if dpkg -l | grep -q unattended-upgrades; then
    security_score=$((security_score + 1))
    echo "âœ… Automatic security updates configured"
else
    echo "âš ï¸  Automatic security updates not configured"
fi
{% else %}
if systemctl is-enabled --quiet yum-cron 2>/dev/null; then
    security_score=$((security_score + 1))
    echo "âœ… Automatic security updates configured"
else
    echo "âš ï¸  Automatic security updates not configured"
fi
{% endif %}

# Check for security tools
if command -v rkhunter >/dev/null 2>&1; then
    security_score=$((security_score + 1))
    echo "âœ… Rootkit scanner installed"
else
    echo "âš ï¸  Rootkit scanner not installed"
fi

# Check SSH security
if [ -f /etc/ssh/sshd_config ]; then
    if grep -q "^PermitRootLogin no\|^PermitRootLogin prohibit-password" /etc/ssh/sshd_config; then
        security_score=$((security_score + 1))
        echo "âœ… SSH root login is restricted"
    else
        echo "âš ï¸  SSH root login may be enabled"
    fi
fi

echo ""
echo "Overall Security Score: $security_score/$max_score"
if [ $security_score -ge 8 ]; then
    echo "ðŸ›¡ï¸  Security Status: EXCELLENT"
elif [ $security_score -ge 6 ]; then
    echo "ðŸ”’ Security Status: GOOD"
elif [ $security_score -ge 4 ]; then
    echo "âš ï¸  Security Status: FAIR - Improvements needed"
else
    echo "âŒ Security Status: POOR - Immediate attention required"
fi

echo ""
echo "=== Recommendations ==="
if [ $security_score -lt $max_score ]; then
    echo "Consider the following improvements:"
    
    if ! systemctl is-active --quiet fail2ban; then
        echo "- Install and configure fail2ban for intrusion prevention"
    fi
    
    {% if ansible_os_family == "RedHat" %}
    if ! command -v getenforce >/dev/null 2>&1 || [ "$(getenforce)" != "Enforcing" ]; then
        echo "- Enable and configure SELinux in enforcing mode"
    fi
    {% endif %}
    
    {% if ansible_os_family == "Debian" %}
    if ! (command -v aa-status >/dev/null 2>&1 && aa-status --enabled); then
        echo "- Install and configure AppArmor profiles"
    fi
    {% endif %}
    
    if ! systemctl is-active --quiet auditd; then
        echo "- Enable audit daemon for security logging"
    fi
    
    {% if ansible_os_family == "RedHat" %}
    if ! systemctl is-active --quiet firewalld; then
        echo "- Configure and enable firewalld"
    fi
    {% else %}
    if ! ufw status | grep -q "Status: active"; then
        echo "- Configure and enable UFW firewall"
    fi
    {% endif %}
    
    echo "- Run regular security updates and scans"
    echo "- Monitor WordPress for suspicious activity"
    echo "- Keep WordPress core, plugins, and themes updated"
else
    echo "Your WordPress installation has excellent security! ðŸŽ‰"
    echo "Continue monitoring and maintaining security best practices."
fi

echo ""
echo "=== Available Security Commands ==="
echo "- wordpress-security-status: Run this security report"
echo "- wordpress-security-maintenance: Run security maintenance tasks"
{% if ansible_os_family == "RedHat" %}
echo "- wordpress-selinux-status: Check SELinux status"
echo "- wordpress-selinux-troubleshoot: SELinux troubleshooting"
{% endif %}
{% if ansible_os_family == "Debian" %}
echo "- wordpress-apparmor-status: Check AppArmor status"
echo "- wordpress-apparmor-troubleshoot: AppArmor troubleshooting"
{% endif %}

echo ""
echo "Report completed at: $(date)"
echo "======================================================="