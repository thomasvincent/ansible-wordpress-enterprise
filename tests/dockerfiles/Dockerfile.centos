# Rocky Linux 9 test target for WordPress Enterprise testing
FROM rockylinux:9

# Install systemd and basic packages
RUN dnf update -y && dnf install -y \
    systemd \
    openssh-server \
    python3 \
    python3-pip \
    curl \
    wget \
    gnupg2 \
    sudo \
    rsyslog \
    cronie \
    logrotate \
    initscripts \
    && dnf clean all

# Configure systemd
RUN systemctl set-default multi-user.target \
    && systemctl enable sshd \
    && systemctl enable rsyslog \
    && systemctl enable crond

# Remove unnecessary systemd services
RUN systemctl disable getty@tty1.service \
    && systemctl mask getty@tty1.service \
    && systemctl mask getty-static.service \
    && systemctl mask graphical-session.target

# Create test user with sudo privileges
RUN useradd -m -s /bin/bash -G wheel testuser \
    && echo 'testuser:testpass123' | chpasswd \
    && echo 'testuser ALL=(ALL) NOPASSWD:ALL' >> /etc/sudoers

# Configure SSH
RUN ssh-keygen -A \
    && echo 'root:testroot123' | chpasswd \
    && sed -i 's/#PermitRootLogin prohibit-password/PermitRootLogin yes/' /etc/ssh/sshd_config \
    && sed -i 's/#PasswordAuthentication yes/PasswordAuthentication yes/' /etc/ssh/sshd_config

# Create directory for WordPress installation
RUN mkdir -p /var/www/html

# Create systemd-compatible init script
COPY tests/fixtures/init-centos.sh /usr/local/bin/init-centos.sh
RUN chmod +x /usr/local/bin/init-centos.sh

# Expose SSH and web ports
EXPOSE 22 80 443

# Use systemd as init system
CMD ["/usr/local/bin/init-centos.sh"]