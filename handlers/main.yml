---
# Handlers for ansible-wordpress-enterprise
# NOTE: Each handler should only be defined once to avoid unexpected behavior

# PHP-FPM Handlers
- name: Restart php-fpm
  ansible.builtin.systemd:
    name: "{{ wordpress_php_fpm_service }}"
    state: restarted
    daemon_reload: true
  become: true

- name: Restart php8.1-fpm
  ansible.builtin.systemd:
    name: php8.1-fpm
    state: restarted
    daemon_reload: true
  become: true

- name: Restart php8.2-fpm
  ansible.builtin.systemd:
    name: php8.2-fpm
    state: restarted
    daemon_reload: true
  become: true

# Nginx Handlers
- name: Reload nginx
  ansible.builtin.systemd:
    name: nginx
    state: reloaded
  become: true

- name: Restart nginx
  ansible.builtin.systemd:
    name: nginx
    state: restarted
  become: true

# Apache Handlers
- name: Reload apache
  ansible.builtin.systemd:
    name: "{{ wordpress_apache_service | default('apache2') }}"
    state: reloaded
  become: true

- name: Restart apache
  ansible.builtin.systemd:
    name: "{{ wordpress_apache_service | default('apache2') }}"
    state: restarted
  become: true

# Database Handlers
- name: Restart mysql
  ansible.builtin.systemd:
    name: "{{ wordpress_mysql_service | default('mysql') }}"
    state: restarted
  become: true

- name: Restart mariadb
  ansible.builtin.systemd:
    name: "{{ wordpress_mariadb_service | default('mariadb') }}"
    state: restarted
  become: true

# Cache Handlers
- name: Restart redis
  ansible.builtin.systemd:
    name: redis
    state: restarted
  become: true

- name: Restart memcached
  ansible.builtin.systemd:
    name: memcached
    state: restarted
  become: true

# Security Handlers
- name: Restart fail2ban
  ansible.builtin.systemd:
    name: fail2ban
    state: restarted
  become: true

- name: Reload firewalld
  ansible.builtin.systemd:
    name: firewalld
    state: reloaded
  become: true

- name: reload apparmor
  ansible.builtin.systemd:
    name: apparmor
    state: reloaded
  become: true
  when: ansible_os_family == "Debian"

- name: restart auditd
  ansible.builtin.systemd:
    name: auditd
    state: restarted
  become: true

- name: restart yum-cron
  ansible.builtin.systemd:
    name: yum-cron
    state: restarted
    enabled: true
  become: true
  when: ansible_os_family == "RedHat"

# Sysctl Handlers
- name: Reload sysctl
  ansible.builtin.command:
    cmd: sysctl -p
  become: true

# SSH Handlers
- name: Restart sshd
  ansible.builtin.service:
    name: sshd
    state: restarted
  become: true

# WP-CLI Handlers
- name: Run wp-cli cache flush
  ansible.builtin.command:
    cmd: wp cache flush --path={{ wordpress_install_dir }}
  become: true
  become_user: "{{ wordpress_system_user }}"

# System Handlers
- name: reboot system
  ansible.builtin.reboot:
    reboot_timeout: 600
    test_command: whoami
  become: true
  when: wordpress_allow_reboot | default(false)
