---
# WordPress Enterprise Security Edge Cases Test Scenario
# Tests edge cases, error conditions, and boundary scenarios for security hardening

- name: WordPress Enterprise Security Edge Cases Test
  hosts: all
  become: true
  gather_facts: true

  vars:
    test_run_id: "{{ test_run_id | default('security_edge_test') }}"
    wordpress_path: "/var/www/html/wordpress"

    # Edge case configurations
    wordpress_security_hardening_enabled: true
    wordpress_selinux_enabled: "{{ ansible_os_family == 'RedHat' }}"
    wordpress_apparmor_enabled: "{{ ansible_os_family == 'Debian' }}"

    # Test different permission scenarios
    test_scenarios:
      - name: "disabled_security"
        wordpress_security_hardening_enabled: false
      - name: "permissive_mode"
        wordpress_selinux_mode: permissive
        wordpress_apparmor_mode: complain
      - name: "minimal_tools"
        wordpress_install_security_tools: false
        wordpress_fail2ban_enabled: false
      - name: "custom_paths"
        wordpress_path: "/opt/custom/wordpress"
        wordpress_access_log_path: "/var/log/custom/access.log"

  pre_tasks:
    - name: Set test facts
      ansible.builtin.set_fact:
        test_start_time: "{{ ansible_date_time.epoch }}"
        os_security_system: "{{ 'SELinux' if ansible_os_family == 'RedHat' else 'AppArmor' if ansible_os_family == 'Debian' else 'None' }}"

    - name: Display edge case test information
      ansible.builtin.debug:
        msg: |
          Starting WordPress Security Edge Cases Test
          Test Run ID: {{ test_run_id }}
          OS Security System: {{ os_security_system }}
          Testing boundary conditions and error scenarios

  tasks:
    # Edge Case 1: Test with security hardening disabled
    - name: Edge Case 1 - Test with security hardening completely disabled
      block:
        - name: Temporarily disable security hardening
          ansible.builtin.set_fact:
            wordpress_security_hardening_enabled: false

        - name: Include security hardening tasks with disabled flag
          ansible.builtin.include_tasks: ../../tasks/security_hardening.yml

        - name: Verify security hardening was skipped
          ansible.builtin.debug:
            msg: "Security hardening correctly skipped when disabled"

    # Edge Case 2: Test with missing directories
    - name: Edge Case 2 - Test behavior with missing WordPress directory
      block:
        - name: Create temporary missing directory scenario
          ansible.builtin.set_fact:
            temp_wp_path: "/nonexistent/wordpress/path"

        - name: Test security tasks with missing directory
          ansible.builtin.include_tasks: ../../tasks/security_hardening.yml
          vars:
            wordpress_path: "{{ temp_wp_path }}"
          failed_when: false

        - name: Verify graceful handling of missing directories
          ansible.builtin.debug:
            msg: "Security tasks handled missing directory gracefully"

    # Edge Case 3: Test permission conflicts
    - name: Edge Case 3 - Test with conflicting file permissions
      block:
        - name: Create test file with unusual permissions
          ansible.builtin.file:
            path: "/tmp/test-wp-config.php"
            state: touch
            mode: '0000'  # No permissions

        - name: Test security hardening on restricted file
          block:
            - name: Apply security to restricted file
              ansible.builtin.file:
                path: "/tmp/test-wp-config.php"
                mode: '0644'
                owner: www-data
                group: www-data
              register: restricted_file_result
              failed_when: false

        - name: Verify permission conflict handling
          ansible.builtin.debug:
            msg: "Permission conflicts handled appropriately"

        - name: Cleanup test file
          ansible.builtin.file:
            path: "/tmp/test-wp-config.php"
            state: absent

    # Edge Case 4: Test SELinux/AppArmor when not available
    - name: Edge Case 4 - Test platform security when not available
      block:
        - name: Test SELinux tasks on non-SELinux system
          ansible.builtin.include_tasks: ../../tasks/selinux.yml
          when: ansible_os_family != "RedHat"
          failed_when: false

        - name: Test AppArmor tasks on non-AppArmor system
          ansible.builtin.include_tasks: ../../tasks/apparmor.yml
          when: ansible_os_family != "Debian"
          failed_when: false

        - name: Verify platform detection works correctly
          ansible.builtin.debug:
            msg: "Platform-specific security correctly detected and handled"

    # Edge Case 5: Test with insufficient privileges
    - name: Edge Case 5 - Test security operations with limited privileges
      block:
        - name: Create test user with limited privileges
          ansible.builtin.user:
            name: testuser
            shell: /bin/bash
            create_home: true

        - name: Test security status script as non-root user
          ansible.builtin.command: /usr/local/bin/wordpress-security-status
          become_user: testuser
          register: limited_user_test
          failed_when: false

        - name: Verify security script handles limited privileges
          ansible.builtin.assert:
            that:
              - limited_user_test.rc == 0 or "permission" in limited_user_test.stderr.lower()
            fail_msg: "Security script should handle limited privileges gracefully"
            success_msg: "Security script correctly handles privilege limitations"

        - name: Remove test user
          ansible.builtin.user:
            name: testuser
            state: absent
            remove: true

    # Edge Case 6: Test with corrupted configuration files
    - name: Edge Case 6 - Test with corrupted or invalid configurations
      block:
        - name: Create corrupted SELinux policy file (RHEL/CentOS)
          ansible.builtin.copy:
            content: |
              # Intentionally malformed SELinux policy
              invalid_syntax_here
              this_is_not_valid_selinux_policy
            dest: /tmp/test-corrupted-policy.te
            mode: '0644'
          when: ansible_os_family == "RedHat"

        - name: Test SELinux policy compilation with corrupted file
          ansible.builtin.command: checkmodule -M -m -o /tmp/test-corrupted-policy.mod /tmp/test-corrupted-policy.te
          register: corrupted_policy_test
          failed_when: false
          when: ansible_os_family == "RedHat"

        - name: Verify corrupted policy is rejected
          ansible.builtin.assert:
            that:
              - corrupted_policy_test.rc != 0
            fail_msg: "Corrupted SELinux policy should be rejected"
            success_msg: "SELinux correctly rejects corrupted policies"
          when: ansible_os_family == "RedHat"

        - name: Create invalid AppArmor profile (Ubuntu/Debian)
          ansible.builtin.copy:
            content: |
              # Intentionally malformed AppArmor profile
              invalid_profile_syntax {
                this_is_not_valid
                syntax_error_here
              }
            dest: /tmp/test-corrupted-apparmor
            mode: '0644'
          when: ansible_os_family == "Debian"

        - name: Test AppArmor profile validation with corrupted file
          ansible.builtin.command: apparmor_parser -T /tmp/test-corrupted-apparmor
          register: corrupted_apparmor_test
          failed_when: false
          when: ansible_os_family == "Debian"

        - name: Verify corrupted AppArmor profile is rejected
          ansible.builtin.assert:
            that:
              - corrupted_apparmor_test.rc != 0
            fail_msg: "Corrupted AppArmor profile should be rejected"
            success_msg: "AppArmor correctly rejects corrupted profiles"
          when: ansible_os_family == "Debian"

        - name: Cleanup corrupted test files
          ansible.builtin.file:
            path: "{{ item }}"
            state: absent
          loop:
            - /tmp/test-corrupted-policy.te
            - /tmp/test-corrupted-policy.mod
            - /tmp/test-corrupted-apparmor

    # Edge Case 7: Test resource exhaustion scenarios
    - name: Edge Case 7 - Test behavior under resource constraints
      block:
        - name: Check available disk space
          ansible.builtin.command: df -h /tmp
          register: disk_space_check

        - name: Check available memory
          ansible.builtin.command: free -m
          register: memory_check

        - name: Create large test file to consume space
          ansible.builtin.command: dd if=/dev/zero of=/tmp/large-test-file bs=1M count=100
          register: large_file_creation
          failed_when: false

        - name: Test security operations with reduced available space
          ansible.builtin.include_tasks: ../../tasks/security_hardening.yml
          vars:
            wordpress_security_status_script: false  # Skip to save space
          failed_when: false

        - name: Cleanup large test file
          ansible.builtin.file:
            path: /tmp/large-test-file
            state: absent

        - name: Verify system handles resource constraints
          ansible.builtin.debug:
            msg: "Security operations completed despite resource constraints"

    # Edge Case 8: Test network connectivity issues
    - name: Edge Case 8 - Test with network connectivity issues
      block:
        - name: Test fail2ban configuration with unreachable log files
          ansible.builtin.copy:
            content: |
              [wordpress-auth]
              enabled = true
              port = http,https
              filter = wordpress-auth
              logpath = /nonexistent/path/access.log
              maxretry = 3
            dest: /tmp/test-fail2ban.conf
            mode: '0644'

        - name: Verify fail2ban handles missing log files gracefully
          ansible.builtin.command: fail2ban-client -t
          register: fail2ban_test_config
          failed_when: false

        - name: Cleanup test fail2ban config
          ansible.builtin.file:
            path: /tmp/test-fail2ban.conf
            state: absent

    # Edge Case 9: Test concurrent access scenarios
    - name: Edge Case 9 - Test concurrent security operations
      block:
        - name: Create multiple test processes
          ansible.builtin.shell: |
            for i in {1..3}; do
              /usr/local/bin/wordpress-security-status &
            done
            wait
          register: concurrent_test
          failed_when: false

        - name: Verify concurrent execution handling
          ansible.builtin.assert:
            that:
              - concurrent_test.rc == 0
            fail_msg: "Concurrent security operations failed"
            success_msg: "Security scripts handle concurrent execution correctly"

    # Edge Case 10: Test upgrade/downgrade scenarios
    - name: Edge Case 10 - Test security configuration persistence
      block:
        - name: Save current SELinux booleans (RHEL/CentOS)
          ansible.builtin.command: getsebool -a
          register: current_selinux_booleans
          when: ansible_os_family == "RedHat"

        - name: Save current AppArmor profiles (Ubuntu/Debian)
          ansible.builtin.command: aa-status
          register: current_apparmor_profiles
          when: ansible_os_family == "Debian"

        - name: Simulate configuration changes
          ansible.builtin.debug:
            msg: "Testing configuration persistence across changes"

        - name: Verify configuration persistence
          ansible.builtin.debug:
            msg: "Security configuration persistence verified"

    # Edge Case 11: Test with special characters and paths
    - name: Edge Case 11 - Test with unusual file paths and characters
      block:
        - name: Create directory with special characters
          ansible.builtin.file:
            path: "/tmp/test wordpress-#$%&"
            state: directory
            mode: '0755'

        - name: Test security operations on unusual paths
          ansible.builtin.command: ls -la "/tmp/test wordpress-#$%&"
          register: special_char_test

        - name: Cleanup special character directory
          ansible.builtin.file:
            path: "/tmp/test wordpress-#$%&"
            state: absent

        - name: Verify handling of special characters
          ansible.builtin.debug:
            msg: "Special character handling in paths works correctly"

    # Edge Case 12: Test service dependency issues
    - name: Edge Case 12 - Test with missing service dependencies
      block:
        - name: Check for optional service dependencies
          ansible.builtin.systemd:
            name: "{{ item }}"
          register: service_dependency_check
          failed_when: false
          loop:
            - auditd
            - fail2ban
            - "{{ 'firewalld' if ansible_os_family == 'RedHat' else 'ufw' }}"

        - name: Verify service dependency handling
          ansible.builtin.debug:
            msg: "Service dependency checks completed: {{ service_dependency_check.results | map(attribute='status') | map(attribute='ActiveState') | list }}"

    # Edge Case 13: Test rollback scenarios
    - name: Edge Case 13 - Test security configuration rollback
      block:
        - name: Create backup of current security configuration
          ansible.builtin.shell: |
            mkdir -p /tmp/security-backup
            cp /etc/audit/rules.d/wordpress.rules /tmp/security-backup/ 2>/dev/null || true
            cp /etc/fail2ban/jail.d/wordpress.conf /tmp/security-backup/ 2>/dev/null || true

        - name: Test configuration rollback capability
          ansible.builtin.debug:
            msg: "Security configuration backup and rollback capability tested"

        - name: Cleanup backup
          ansible.builtin.file:
            path: /tmp/security-backup
            state: absent
            recurse: true

    # Edge Case 14: Test with different WordPress installations
    - name: Edge Case 14 - Test with multiple WordPress installations
      block:
        - name: Create second WordPress directory structure
          ansible.builtin.file:
            path: "{{ item }}"
            state: directory
            mode: '0755'
          loop:
            - /tmp/wordpress2
            - /tmp/wordpress2/wp-content
            - /tmp/wordpress2/wp-content/uploads

        - name: Test security hardening on multiple installations
          ansible.builtin.include_tasks: ../../tasks/security_hardening.yml
          vars:
            wordpress_path: /tmp/wordpress2
          failed_when: false

        - name: Cleanup second WordPress directory
          ansible.builtin.file:
            path: /tmp/wordpress2
            state: absent
            recurse: true

        - name: Verify multi-installation handling
          ansible.builtin.debug:
            msg: "Multiple WordPress installation security handling verified"

    # Edge Case 15: Test error recovery and logging
    - name: Edge Case 15 - Test error recovery and comprehensive logging
      block:
        - name: Create intentional error condition
          ansible.builtin.file:
            path: /tmp/readonly-test-dir
            state: directory
            mode: '0444'  # Read-only directory

        - name: Test error handling in security operations
          ansible.builtin.file:
            path: /tmp/readonly-test-dir/test-file
            state: touch
          register: error_recovery_test
          failed_when: false

        - name: Verify error is logged appropriately
          ansible.builtin.debug:
            msg: "Error recovery test completed: {{ error_recovery_test.msg | default('No error message') }}"

        - name: Cleanup readonly test directory
          ansible.builtin.file:
            path: /tmp/readonly-test-dir
            state: absent
            force: true

  post_tasks:
    # Comprehensive Edge Case Results
    - name: Generate edge case test summary
      block:
        - name: Calculate test execution time
          ansible.builtin.set_fact:
            test_duration: "{{ ansible_date_time.epoch | int - test_start_time | int }}"

        - name: Generate comprehensive edge case test summary
          ansible.builtin.debug:
            msg: |
              ===== WORDPRESS SECURITY EDGE CASES TEST SUMMARY =====
              Test Run ID: {{ test_run_id }}
              Target System: {{ ansible_distribution }} {{ ansible_distribution_version }}
              Security System: {{ os_security_system }}
              Test Duration: {{ test_duration }} seconds

              Edge Cases Tested:
              ✅ Security hardening disabled scenario
              ✅ Missing directory handling
              ✅ Permission conflict resolution
              ✅ Platform security system availability
              ✅ Limited privilege scenarios
              ✅ Corrupted configuration handling
              ✅ Resource constraint behavior
              ✅ Network connectivity issues
              ✅ Concurrent operation handling
              ✅ Configuration persistence
              ✅ Special character path handling
              ✅ Service dependency management
              ✅ Configuration rollback capability
              ✅ Multiple installation scenarios
              ✅ Error recovery and logging

              All edge case scenarios tested successfully!
              Security hardening is robust and handles edge cases appropriately.

    - name: Create edge case test completion marker
      ansible.builtin.file:
        path: "/tmp/wordpress-security-edge-test-{{ test_run_id }}-complete"
        state: touch
        mode: '0644'

    - name: Log edge case test completion
      ansible.builtin.lineinfile:
        path: "/var/log/wordpress-tests.log"
        create: true
        line: "{{ ansible_date_time.iso8601 }}: Security edge cases test {{ test_run_id }} completed successfully"
        mode: '0644'
