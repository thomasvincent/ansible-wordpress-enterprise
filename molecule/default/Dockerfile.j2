# Molecule managed

FROM {{ item.image }}

{% if item.image.startswith('ubuntu') %}
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
    python3-minimal \
    python3-pip \
    python3-setuptools \
    python3-apt \
    sudo \
    systemd \
    systemd-sysv \
    build-essential \
    && rm -rf /var/lib/apt/lists/*

{% elif item.image.startswith('rockylinux') or item.image.startswith('centos') %}
RUN dnf -y install \
    python3 \
    python3-pip \
    sudo \
    which \
    systemd \
    && dnf clean all

{% endif %}

# Create molecule user
RUN useradd -m -s /bin/bash molecule && \
    echo "molecule ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers.d/molecule

# Install Ansible (handle PEP 668 for Ubuntu 24.04)
{% if item.image == 'ubuntu:24.04' %}
# Don't upgrade system pip on Ubuntu 24.04 as it causes conflicts
RUN python3 -m pip install ansible --break-system-packages
{% else %}
RUN python3 -m pip install --upgrade pip && \
    python3 -m pip install ansible
{% endif %}

WORKDIR /tmp

# Clean up
RUN rm -rf /var/cache/apk/* /tmp/* /var/tmp/*

# Ensure systemd is properly configured for Ubuntu
{% if item.image.startswith('ubuntu') %}
RUN systemctl mask systemd-remount-fs.service \
    dev-hugepages.mount \
    sys-fs-fuse-connections.mount \
    systemd-logind.service \
    getty.target \
    console-getty.service
{% endif %}

CMD [{{ item.command }}]