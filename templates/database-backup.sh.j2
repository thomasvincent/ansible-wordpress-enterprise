#!/bin/bash
# WordPress Database Backup Script
# Generated by Ansible - Do not edit manually

# Configuration
DB_HOST="{{ wordpress_db_host }}"
DB_PORT="{{ wordpress_db_port }}"
DB_NAME="{{ wordpress_db_name }}"
DB_USER="{{ wordpress_db_user }}"
DB_PASS="{{ wordpress_db_password }}"
BACKUP_DIR="{{ wordpress_backup_dir | default('/var/backups/wordpress') }}/database"
DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_FILE="${BACKUP_DIR}/wordpress_${DATE}.sql"
RETENTION_DAYS="{{ wordpress_backup_retention_days | default('30') }}"

# Logging
LOG_FILE="/var/log/wordpress-backup.log"
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a "$LOG_FILE"
}

# Create backup directory if it doesn't exist
mkdir -p "$BACKUP_DIR"

# Create backup
log "Starting WordPress database backup..."
mysqldump \
    --host="$DB_HOST" \
    --port="$DB_PORT" \
    --user="$DB_USER" \
    --password="$DB_PASS" \
    --single-transaction \
    --routines \
    --triggers \
    --add-drop-table \
    --extended-insert \
    --create-options \
    --quick \
    --lock-tables=false \
    "$DB_NAME" > "$BACKUP_FILE"

if [ $? -eq 0 ]; then
    log "Database backup completed successfully: $BACKUP_FILE"
    
    # Compress the backup
    gzip "$BACKUP_FILE"
    COMPRESSED_FILE="${BACKUP_FILE}.gz"
    log "Backup compressed: $COMPRESSED_FILE"
    
    # Set proper permissions
    chmod 600 "$COMPRESSED_FILE"
    
    # Clean up old backups
    log "Cleaning up backups older than $RETENTION_DAYS days..."
    find "$BACKUP_DIR" -name "wordpress_*.sql.gz" -mtime +$RETENTION_DAYS -delete
    
    log "Backup cleanup completed"
else
    log "ERROR: Database backup failed!"
    exit 1
fi