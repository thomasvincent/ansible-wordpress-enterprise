---
name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 1.0.0)'
        required: true
        type: string

permissions:
  contents: write

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v6

      - name: Set up Python
        uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405  # v6
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install molecule[docker] ansible-core docker ansible-lint

      - name: Run ansible-lint
        run: ansible-lint

      - name: Run Molecule tests
        run: molecule test
        env:
          PY_COLORS: '1'
          ANSIBLE_FORCE_COLOR: '1'

  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: test

    steps:
      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v6
        with:
          fetch-depth: 0

      - name: Determine version
        id: version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="${GITHUB_REF#refs/tags/v}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      - name: Generate changelog
        id: changelog
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          CHANGELOG=$(git log --pretty=format:"- %s" $(git describe --tags --abbrev=0 HEAD^)..HEAD 2>/dev/null || git log --pretty=format:"- %s")
          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b  # v2
        with:
          tag_name: v${{ steps.version.outputs.version }}
          name: Release v${{ steps.version.outputs.version }}
          body: |
            ## Release v${{ steps.version.outputs.version }}

            ### Changes
            ${{ steps.changelog.outputs.changelog }}

            ### Installation

            ```bash
            ansible-galaxy install thomasvincent.wordpress_enterprise,v${{ steps.version.outputs.version }}
            ```

            Or from GitHub:

            ```bash
            ansible-galaxy install git+https://github.com/${{ github.repository }}.git,v${{ steps.version.outputs.version }}
            ```

            ### Quick Start

            ```yaml
            - name: Deploy WordPress
              hosts: wordpress_servers
              become: true
              roles:
                - role: thomasvincent.wordpress_enterprise
                  vars:
                    wordpress_site_url: "https://example.com"
                    wordpress_site_title: "My WordPress Site"
                    wordpress_admin_user: "admin"
                    wordpress_admin_email: "admin@example.com"
            ```

            ### Documentation

            Full documentation is available in the [README.md](README.md)

            ### Examples

            Check out the `examples/` directory for cloud-specific configurations:
            - AWS
            - Google Cloud Platform
            - Microsoft Azure
            - DigitalOcean
            - Cloudflare
            - Oracle Cloud
            - Multi-cloud HA
          draft: false
          prerelease: false

  publish-galaxy:
    name: Publish to Ansible Galaxy
    runs-on: ubuntu-latest
    needs: [test, release]
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')

    steps:
      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v6

      - name: Set up Python
        uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405  # v6
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install Ansible
        run: pip install ansible-core

      - name: Publish to Galaxy
        run: |
          ansible-galaxy role import --api-key=${{ secrets.GALAXY_API_KEY }} thomasvincent ansible-wordpress-enterprise
        continue-on-error: true
