---
# Validation tasks for WordPress Enterprise Role

- name: Validate required variables are defined
  ansible.builtin.assert:
    that:
      - wordpress_install_dir is defined
      - wordpress_db_name is defined
      - wordpress_db_user is defined
      - wordpress_db_password is defined
      - wordpress_admin_user is defined
      - wordpress_admin_password is defined
      - wordpress_admin_email is defined
      - wordpress_web_server in ['nginx', 'apache']
      - wordpress_db_engine in ['mysql', 'mariadb']
      - wordpress_php_version is defined
    fail_msg: "Required WordPress configuration variables are not properly defined"
    success_msg: "All required WordPress configuration variables are defined"

- name: Validate PHP version compatibility
  ansible.builtin.assert:
    that:
      - wordpress_php_version is version('7.4', '>=')
      - wordpress_php_version is version('8.4', '<')
    fail_msg: "PHP version {{ wordpress_php_version }} is not supported. Use PHP 7.4 to 8.3"
    success_msg: "PHP version {{ wordpress_php_version }} is supported"

- name: Validate WordPress admin email format
  ansible.builtin.assert:
    that:
      - wordpress_admin_email is match('^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$')
    fail_msg: "WordPress admin email '{{ wordpress_admin_email }}' is not valid"
    success_msg: "WordPress admin email format is valid"

- name: Check if distribution is supported
  ansible.builtin.assert:
    that:
      - ansible_distribution in ['Ubuntu', 'Debian', 'RedHat', 'CentOS', 'Rocky', 'AlmaLinux']
    fail_msg: "Distribution {{ ansible_distribution }} is not supported"
    success_msg: "Distribution {{ ansible_distribution }} is supported"

- name: Validate SSL configuration
  ansible.builtin.assert:
    that:
      - wordpress_ssl_certificate is defined
      - wordpress_ssl_certificate_key is defined
    fail_msg: "SSL is enabled but certificate paths are not defined"
    success_msg: "SSL configuration is valid"
  when: wordpress_enable_ssl | bool

- name: Validate backup configuration
  ansible.builtin.assert:
    that:
      - wordpress_backup_dir is defined
      - wordpress_backup_retention_days is defined
      - wordpress_backup_retention_days | int > 0
    fail_msg: "Backup configuration is invalid"
    success_msg: "Backup configuration is valid"
  when: wordpress_enable_backups | bool

